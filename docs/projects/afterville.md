# Afterville

# NPC AI

The feature on which I spent the most time refining is NPC AI. In the game, we have NPCs with whom players can interact, each with a unique schedule, appearance, and personality. Each NPC must have an AI to support its in-game behaviours. I have previously created AI in Unity, where I have experimented with behaviour trees for the behaviour of monsters or quest NPCs. However, the behaviours I have created are all based on state-switching. For example, they only need to move from a wandering state to a search state when they detect the player. For the NPCs in our game, however, I realise the difficulty of creating their behaviours in a behaviour tree. It would be incredibly challenging because they do not behave on a state-by-state basis. Instead, they have a schedule that they must follow. For instance, on Monday at 6 o'clock, the Mayor would be at his house, then go to his office to work. At the same time, we still need the capability of behaviour trees since characters have different states. At each location, they would have other behaviours. For example, at the saloon, the NPC would sit at a specific spot, and at home, they would instead wander around. Eventually, considering all these factors, I found a solution incorporating a behaviour tree and their daily schedules to create the NPC AI.

![NPCBehaviorTree](../img/afterville/Afterville_NPCSchedule.png)

The solution I found was to have each NPC read from a CSV file that contains their daily schedule and check whether they are at the correct location every hour. They will move to the new location if their behaviour changes compared to the last hour. If not, they would stay put and resume their actions. The CSV file informs the NPC AI of the location they need to be. For the NPC's actual behaviour when they have arrived at their designated spot, I control it with a behaviour tree, depending on which gameplay tag they have (wander, roam, still). 

I realised another challenge I needed to solve when implementing the behaviour tree. I wanted to make NPCs wander around randomly as a behaviour. However, combining their schedules, I needed the NPC to only wander in a designated area. However, this goes counter to letting them wander randomly. I could circle an area for them to wander every time and set it up for every NPC for every location, but that could be error-prone. Also, our art production side was slow, and we only had a white box of the map at that stage. When we bring in our final map, I need to set up the area limitation for NPC wander again for each location. It was not an optimal solution. Eventually, I got a good idea that would save time and allow the NPCs to only wander in their designated area. This method only required each NPC to have one location saved for every action. When they arrive at their scheduled location, they are allowed to wander randomly. However, they would be forced back to their starting location after a while. This action puts the NPC on a leash and does not look jarring in the game. I simply need to place their returning location where they are supposed to frequent, for example, the Mayor's office desk or a saloon chair. Using this method, I saved unnecessary set-ups that could have been error-prone. 

![NPCBehaviorTree](../img/afterville/Afterville_NPCBehaviorTree.png)

In the end, I achieved three different behaviours: wander, when the NPC needs to walk around a designated area; roam, when the NPC needs to roam without any limitations; still, when the NPC needs to stay still, for example, sitting for church. All this only required every NPC to record one vector location value for each of their possible actions.